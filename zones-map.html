<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–¢–µ–ø–ª–æ–∫–∞—Ä—Ç–∞ (—Å–ª–æ–∏ + –∑–æ–Ω—ã + –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { height: 100%; display: grid; grid-template-columns: 520px 1fr; }
    #sidebar { padding: 14px; overflow: auto; border-right: 1px solid #e5e5e5; background: #fff; }
    #map { height: 100%; }

    h1 { font-size: 18px; margin: 0 0 10px; font-weight: 900; }
    .muted { color:#666; font-size: 12px; line-height: 1.35; }

    .card { border:1px solid #eee; border-radius: 12px; padding: 12px; margin: 12px 0; background:#fafafa; }
    .label { font-weight: 900; margin: 0 0 8px; font-size: 13px; }
    .small { font-size: 12px; color:#666; line-height: 1.35; }

    .btn { padding: 10px 12px; border:1px solid #ddd; border-radius: 10px; background:#fff; cursor:pointer; font-weight: 800; font-size: 13px; width: 100%; text-align:left; }
    .btn.primary { border-color:#2f6fed; color:#2f6fed; }
    .btn + .btn { margin-top: 8px; }

    input[type="range"] { width:100%; }
    input[type="text"] { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:13px; }
    textarea { width:100%; height: 180px; border:1px solid #ddd; border-radius:10px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; }

    #layersList { max-height: 520px; overflow-y: auto; padding-right: 6px; }

    .layerItem { background:#fff; border: 1px solid #e8e8e8; border-radius: 12px; padding: 10px; margin-bottom: 10px; cursor: pointer; transition: 0.15s; }
    .layerItem:hover { border-color:#cfcfcf; }
    .layerItem.active { border: 2px solid #ff7a00; background: #fff5ea; }

    .layerTop { display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-bottom: 8px; }
    .layerName { font-weight: 900; font-size: 13px; }
    .pill { font-size: 11px; padding: 4px 8px; border-radius: 999px; border:1px solid #ddd; background:#fafafa; color:#555; white-space: nowrap; }

    .row { display:flex; gap: 8px; flex-wrap: wrap; }
    .mini { padding: 8px 10px; border-radius: 10px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight: 800; font-size: 12px; flex: 1 1 auto; text-align: center; }
    .mini.ok { border-color:#1a7f37; color:#1a7f37; }
    .mini.danger { border-color:#e5484d; color:#e5484d; }

    .zones { display:flex; gap:8px; flex-wrap: wrap; }
    .zonebtn { flex:1 1 46%; border-radius: 10px; padding: 10px; border:2px solid #ddd; cursor:pointer; font-weight: 900; background:#fff; }
    .zonebtn.active { outline: 2px solid #111; }

    .result { background:#fff; border:1px solid #eee; border-radius: 10px; padding: 10px; font-size: 12px; line-height: 1.45; }

    .toast { position: fixed; left: 12px; bottom: 12px; z-index: 999999; background: rgba(20,20,20,0.92); color: #fff;
      padding: 10px 12px; border-radius: 12px; font-size: 12px; display:none; max-width: 560px; }

    .kbdBox { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; align-items: center; }
    .kbdBtn { padding: 10px; border: 1px solid #ddd; border-radius: 10px; background: #fff; cursor: pointer; font-weight: 900; text-align: center; user-select: none; }
    .kbdBtn:active { transform: translateY(1px); }

    .hint { margin-top: 8px; font-size: 12px; color: #444; background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 10px; line-height: 1.4; }
    code { background:#f3f3f3; padding: 2px 6px; border-radius: 6px; }
    .warn { background:#fff2f2; border:1px solid #ffd1d1; color:#8a1f1f; padding:10px; border-radius:10px; font-size:12px; margin-top:10px; display:none; }
  </style>
</head>
<body>

<div id="app">
  <div id="sidebar">
    <h1>–¢–µ–ø–ª–æ–∫–∞—Ä—Ç–∞ (—Å–ª–æ–∏ + –∑–æ–Ω—ã)</h1>
    <div class="muted">
      ‚Ä¢ –ù–æ–≤—ã–π —Å–ª–æ–π –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è <b>—Ä–∞–∑—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º</b> (–¥–≤–∏–≥–∞–π —Å—Ä–∞–∑—É).<br>
      ‚Ä¢ –†–∏—Å–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è/–≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞–º–∏ –ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–ª–∏ <b>Esc</b>.<br>
      ‚Ä¢ –£–¥–∞–ª–µ–Ω–∏–µ –∑–æ–Ω—ã: <b>–ü–ö–ú</b> –ø–æ –∑–æ–Ω–µ ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí —É–¥–∞–ª–∏—Ç—å.<br>
      ‚Ä¢ –ò–º–ø–æ—Ä—Ç –∑–æ–Ω: –≤—Å—Ç–∞–≤—å GeoJSON –≤ –ø–æ–ª–µ –∏ –Ω–∞–∂–º–∏ <b>–ò–º–ø–æ—Ä—Ç</b>.
    </div>
    <div id="protoWarn" class="warn"></div>

    <div class="card">
      <div class="label">–°–ª–æ–∏ (—Å–∫—Ä–∏–Ω—ã)</div>
      <button class="btn primary" id="btnAddLayers">üñº –î–æ–±–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω(—ã)</button>
      <input id="imgFiles" type="file" accept="image/*" multiple style="display:none">
      <div style="margin-top:10px" id="layersList"></div>

      <div class="label" style="margin-top:14px">–î–≤–∏–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ª–æ—è</div>
      <div class="kbdBox">
        <button class="kbdBtn" id="btnScaleUp" title="–£–≤–µ–ª–∏—á–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É">Ôºã</button>
        <button class="kbdBtn" id="btnUp">‚Üë</button>
        <button class="kbdBtn" id="btnScaleDown" title="–£–º–µ–Ω—å—à–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É">Ôºç</button>

        <button class="kbdBtn" id="btnLeft">‚Üê</button>
        <button class="kbdBtn" id="btnFit">‚õ∂</button>
        <button class="kbdBtn" id="btnRight">‚Üí</button>

        <div></div>
        <button class="kbdBtn" id="btnDown">‚Üì</button>
        <div></div>
      </div>

      <div class="hint">
        –®–∞–≥ –¥–≤–∏–∂–µ–Ω–∏—è: <b>5–º</b> (Alt=1–º, Shift=20–º, Ctrl/‚åò=50–º).<br>
        <b>Ôºã/Ôºç</b> ‚Äî –º–∞—Å—à—Ç–∞–± –∫–∞—Ä—Ç–∏–Ω–∫–∏. <b>‚õ∂</b> ‚Äî —Ä–∞—Å—Ç—è–Ω—É—Ç—å —Å–ª–æ–π –Ω–∞ —ç–∫—Ä–∞–Ω.<br>
        –î–≤–∏–≥–∞—Ç—å/–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ª–æ–π <b>—Ä–∞–∑—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω</b>.
      </div>
    </div>

    <div class="card">
      <div class="label">–ü—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å (—Ä–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è)</div>
      <div class="zones">
        <button class="zonebtn" id="zGreat"  style="border-color:#ff2d2d;">üî¥ 1000+ /—á</button>
        <button class="zonebtn" id="zNormal" style="border-color:#ff8a00;">üü† 500‚Äì1000 /—á</button>
        <button class="zonebtn" id="zMedium" style="border-color:#ffd400;">üü° 100‚Äì500 /—á</button>
        <button class="zonebtn" id="zLow"    style="border-color:#39c16c;">üü¢ 0‚Äì100 /—á</button>
      </div>
      <div class="small" style="margin-top:8px">
        –ë—É—Ñ–µ—Ä (—à–∏—Ä–∏–Ω–∞ –ø–æ–ª–æ—Å—ã) = <b>30–º</b> –¥–ª—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π. –í—ã–π—Ç–∏ –∏–∑ —Ä–∏—Å–æ–≤–∞–Ω–∏—è: <b>Esc</b> –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞–∂–º–∏ –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É —É—Ä–æ–≤–Ω—è.
      </div>
      <div class="small" style="margin-top:8px">
        –°–µ–π—á–∞—Å: <b id="drawState">–†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ</b>
      </div>
    </div>

    <div class="card">
      <div class="label">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</div>
      <input id="coordsInput" type="text" placeholder="lat,lng –∏–ª–∏ lng,lat –∏–ª–∏ <coords>..</coords>">
      <button class="btn" id="btnCheckCoords" style="margin-top:10px">üîé –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      <div id="coordsResult" class="result" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="label">–≠–∫—Å–ø–æ—Ä—Ç / –∏–º–ø–æ—Ä—Ç –∑–æ–Ω (GeoJSON)</div>
      <div class="row">
        <button class="btn" id="btnExport">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç GeoJSON</button>
        <button class="btn" id="btnImport">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç GeoJSON</button>
      </div>
      <textarea id="geojsonBox" spellcheck="false" style="margin-top:10px"></textarea>
      <div class="small" style="margin-top:8px">
        –ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â–∏–µ –∑–æ–Ω—ã.
      </div>
    </div>
  </div>

  <div id="map"></div>
</div>

<div id="toast" class="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

<script>
  // =====================
  // Warning for file://
  // =====================
  const protoWarn = document.getElementById("protoWarn");
  if (location.protocol === "file:") {
    protoWarn.style.display = "block";
    protoWarn.innerHTML = `
      –¢—ã –æ—Ç–∫—Ä—ã–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–∫ <b>file://</b>. –ù–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö Mac/Safari —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (IndexedDB/localStorage) –±—ã–≤–∞–µ—Ç –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ.<br>
      –ó–∞–ø—É—Å–∫–∞–π —Ç–∞–∫: <code>python3 -m http.server 8080</code> –∏ –æ—Ç–∫—Ä—ã–≤–∞–π <code>http://localhost:8080/zones-map.html</code>.
    `;
  }

  // =====================
  // Toast
  // =====================
  const toast = document.getElementById('toast');
  let toastTimer = null;
  function showToast(text, ms=1400) {
    toast.textContent = text;
    toast.style.display = 'block';
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.style.display = 'none', ms);
  }

  // =====================
  // Map
  // =====================
  const map = L.map('map').setView([59.9386, 30.3141], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 }).addTo(map);

  // =====================
  // IndexedDB (images)
  // =====================
  const DB_NAME = "netwings_heat_db_v3";
  const DB_STORE = "layers";
  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(DB_STORE)) db.createObjectStore(DB_STORE, { keyPath: "id" });
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function idbPutLayer(id, dataUrl) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(DB_STORE, "readwrite");
      tx.objectStore(DB_STORE).put({ id, dataUrl });
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => reject(tx.error);
    });
  }
  async function idbGetLayer(id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(DB_STORE, "readonly");
      const req = tx.objectStore(DB_STORE).get(id);
      req.onsuccess = () => resolve(req.result?.dataUrl || null);
      req.onerror = () => reject(req.error);
    });
  }
  async function idbDeleteLayer(id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(DB_STORE, "readwrite");
      tx.objectStore(DB_STORE).delete(id);
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => reject(tx.error);
    });
  }

  // =====================
  // Persist keys
  // =====================
  const META_KEY   = "netwings_heat_layers_meta_v3";
  const ACTIVE_KEY = "netwings_heat_layers_active_v3";
  const ZONES_KEY  = "netwings_heat_zones_geojson_v2";

  // =====================
  // Zones config
  // =====================
  const ZONES = {
    great:  { label: "1000+/—á",    score: 100, color: "#ff2d2d" },
    normal: { label: "500‚Äì1000/—á", score: 70,  color: "#ff8a00" },
    medium: { label: "100‚Äì500/—á",  score: 40,  color: "#ffd400" },
    low:    { label: "0‚Äì100/—á",    score: 10,  color: "#39c16c" }
  };
  const BUFFER_M = 30;

  let activeZoneKey = null;   // null = —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ
  const drawState = document.getElementById("drawState");

  // =====================
  // Zones layer group
  // =====================
  const zonesGroup = new L.FeatureGroup().addTo(map);

  // Edit toolbar only (–±–µ–∑ draw –∫–Ω–æ–ø–æ–∫ ‚Äî —Ä–∏—Å—É–µ–º —Å–∞–º–∏ —á–µ—Ä–µ–∑ zone-–∫–Ω–æ–ø–∫–∏)
  const editOnly = new L.Control.Draw({
    edit: { featureGroup: zonesGroup },
    draw: false
  });
  map.addControl(editOnly);

  // =====================
  // Continuous Polyline drawer
  // =====================
  let polyDrawer = null;

  function makeProps(typeKey) {
    const z = ZONES[typeKey];
    return { zone_type: typeKey, zone_label: z.label, zone_score: z.score, buffer_m: BUFFER_M };
  }

  function setDrawStateText() {
    if (!activeZoneKey) {
      drawState.textContent = "–†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ";
    } else {
      drawState.textContent = `–†–∏—Å–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ: ${ZONES[activeZoneKey].label}`;
    }
  }

  function disableDrawing() {
    try { if (polyDrawer) polyDrawer.disable(); } catch(e) {}
  }

  function enableDrawing() {
    if (!activeZoneKey) return;
    if (!polyDrawer) polyDrawer = new L.Draw.Polyline(map, { shapeOptions: { } });
    try { polyDrawer.enable(); } catch(e) {}
  }

  function clearZoneButtonsUI() {
    document.querySelectorAll(".zonebtn").forEach(b => b.classList.remove("active"));
  }

  function toggleZone(zoneKey) {
    if (activeZoneKey === zoneKey) {
      activeZoneKey = null;
      clearZoneButtonsUI();
      disableDrawing();
      setDrawStateText();
      showToast("–†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ");
      return;
    }

    activeZoneKey = zoneKey;
    clearZoneButtonsUI();
    const btnId = zoneKey === "great" ? "zGreat" :
                  zoneKey === "normal" ? "zNormal" :
                  zoneKey === "medium" ? "zMedium" : "zLow";
    document.getElementById(btnId).classList.add("active");

    setDrawStateText();
    showToast(`–†–∏—Å–æ–≤–∞–Ω–∏–µ: ${ZONES[zoneKey].label}`);
    enableDrawing();
  }

  document.getElementById("zGreat").onclick  = () => toggleZone("great");
  document.getElementById("zNormal").onclick = () => toggleZone("normal");
  document.getElementById("zMedium").onclick = () => toggleZone("medium");
  document.getElementById("zLow").onclick    = () => toggleZone("low");

  window.addEventListener("keydown", (ev) => {
    if (ev.key === "Escape") {
      ev.preventDefault();
      activeZoneKey = null;
      clearZoneButtonsUI();
      disableDrawing();
      setDrawStateText();
      showToast("–†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ (Esc)");
    }
  }, { passive:false });

  // =====================
  // Save/load zones
  // =====================
  const geojsonBox = document.getElementById("geojsonBox");

  function saveZonesToStorage() {
    try {
      const gj = zonesGroup.toGeoJSON();
      localStorage.setItem(ZONES_KEY, JSON.stringify(gj));
    } catch(e) {}
  }

  function updateGeo() {
    const gj = zonesGroup.toGeoJSON();
    geojsonBox.value = JSON.stringify(gj, null, 2);
    saveZonesToStorage();
  }

  function attachDeleteOnRightClick(layer) {
    layer.on("contextmenu", (e) => {
      if (e?.originalEvent) e.originalEvent.preventDefault();
      const ok = confirm("–¢–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–æ–Ω—É?");
      if (!ok) return;
      zonesGroup.removeLayer(layer);
      updateGeo();
      showToast("–ó–æ–Ω–∞ —É–¥–∞–ª–µ–Ω–∞");
    });
  }

  function styleForFeature(f) {
    const t = f?.properties?.zone_type || "low";
    const z = ZONES[t] || ZONES.low;
    return { color: z.color, weight: 2, fillColor: z.color, fillOpacity: 0.18 };
  }

  function addGeoJsonToZonesGroup(gj) {
    const layer = L.geoJSON(gj, { style: styleForFeature });
    layer.eachLayer(l => {
      try { l.options.interactive = true; } catch(e) {}
      attachDeleteOnRightClick(l);
      zonesGroup.addLayer(l);
    });
  }

  function loadZonesFromStorage() {
    const raw = localStorage.getItem(ZONES_KEY);
    if (!raw) return;
    try {
      const gj = JSON.parse(raw);
      addGeoJsonToZonesGroup(gj);
    } catch(e) {}
  }

  document.getElementById("btnExport").onclick = updateGeo;

  document.getElementById("btnImport").onclick = () => {
    let gj;
    try {
      gj = JSON.parse(geojsonBox.value || "");
    } catch (e) {
      alert("–ù–µ –º–æ–≥—É –ø—Ä–æ—á–∏—Ç–∞—Ç—å JSON. –ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç GeoJSON.");
      return;
    }

    const ok = gj && (gj.type === "FeatureCollection" || gj.type === "Feature");
    if (!ok) {
      alert("–≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ GeoJSON (FeatureCollection/Feature).");
      return;
    }

    zonesGroup.clearLayers();
    addGeoJsonToZonesGroup(gj);
    updateGeo();
    showToast("–ó–æ–Ω—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
  };

  // =====================
  // Create zones from drawn polyline (buffer)
  // =====================
  map.on(L.Draw.Event.CREATED, (event) => {
    if (!activeZoneKey) {
      try { event.layer.remove(); } catch(e) {}
      return;
    }

    const z = ZONES[activeZoneKey];
    const line = event.layer.toGeoJSON();
    const buffered = turf.buffer(line, BUFFER_M / 1000, { units: "kilometers" });

    const polyLayer = L.geoJSON(buffered, { style: { color: z.color, weight: 2, fillColor: z.color, fillOpacity: 0.18 } });
    polyLayer.eachLayer(l => {
      l.feature = l.feature || { type:"Feature", properties:{}, geometry:null };
      Object.assign(l.feature.properties, makeProps(activeZoneKey));
      attachDeleteOnRightClick(l);
      zonesGroup.addLayer(l);
    });

    updateGeo();

    setTimeout(() => {
      if (activeZoneKey) enableDrawing();
    }, 0);
  });

  map.on("draw:edited", () => updateGeo());
  map.on("draw:deleted", () => updateGeo());

  // =====================
  // Layers (screens)
  // =====================
  const layersList = document.getElementById("layersList");
  const btnAddLayers = document.getElementById("btnAddLayers");
  const imgFiles = document.getElementById("imgFiles");

  let layers = [];
  let activeLayerId = null;

  function genId() { return "L" + Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function fileToDataURL(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onerror = () => reject(new Error("FileReader error"));
      r.onload  = () => resolve(r.result);
      r.readAsDataURL(file);
    });
  }

  function serializeBounds(bounds) {
    const sw = bounds.getSouthWest();
    const ne = bounds.getNorthEast();
    return { sw: {lat: sw.lat, lng: sw.lng}, ne: {lat: ne.lat, lng: ne.lng} };
  }
  function deserializeBounds(obj) {
    return L.latLngBounds([obj.sw.lat, obj.sw.lng], [obj.ne.lat, obj.ne.lng]);
  }

  function saveMeta() {
    const payload = layers.map(l => ({
      id: l.id,
      opacity: l.opacity,
      locked: l.locked,
      bounds: l.boundsObj
    }));
    localStorage.setItem(META_KEY, JSON.stringify(payload));
    localStorage.setItem(ACTIVE_KEY, activeLayerId || "");
  }

  function getLayer(id) { return layers.find(x => x.id === id) || null; }
  function getActiveLayer() { return getLayer(activeLayerId); }

  function syncActiveOutline() {
    layers.forEach(l => {
      if (!l.outline) return;
      if (l.id === activeLayerId) {
        map.addLayer(l.outline);
      } else {
        map.removeLayer(l.outline);
      }
    });
  }

  function setActiveLayer(id) {
    activeLayerId = id;
    layers.forEach(l => l.overlay.setZIndex(l.id === activeLayerId ? 1000 : 500));
    renderLayersList();
    syncActiveOutline();
    saveMeta();
  }

  function updateOpacity(id, opacity01) {
    const l = getLayer(id);
    if (!l) return;
    l.opacity = opacity01;
    l.overlay.setOpacity(opacity01);
    saveMeta();
  }

  function toggleLock(id) {
    const l = getLayer(id);
    if (!l) return;
    l.locked = !l.locked;
    renderLayersList();
    saveMeta();
    showToast(l.locked ? "–°–ª–æ–π –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω" : "–°–ª–æ–π —Ä–∞–∑—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω");
  }

  function fitToScreen(id) {
    const l = getLayer(id);
    if (!l) return;
    const b = map.getBounds();
    l.overlay.setBounds(b);
    l.boundsObj = serializeBounds(b);
    l.outline.setBounds(b);
    saveMeta();
    showToast("–°–ª–æ–π —Ä–∞—Å—Ç—è–Ω—É—Ç –Ω–∞ —ç–∫—Ä–∞–Ω");
  }

  async function deleteLayer(id) {
    const idx = layers.findIndex(x => x.id === id);
    if (idx < 0) return;
    const l = layers[idx];
    map.removeLayer(l.overlay);
    map.removeLayer(l.outline);
    layers.splice(idx, 1);
    await idbDeleteLayer(id);

    if (activeLayerId === id) activeLayerId = layers.length ? layers[0].id : null;
    saveMeta();
    renderLayersList();
    syncActiveOutline();
  }

  function renderLayersList() {
    layersList.innerHTML = "";
    if (!layers.length) {
      layersList.innerHTML = `<div class="small">–°–ª–æ—ë–≤ –Ω–µ—Ç. –ù–∞–∂–º–∏ ‚Äú–î–æ–±–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω(—ã)‚Äù.</div>`;
      return;
    }

    layers.forEach(l => {
      const isActive = l.id === activeLayerId;

      const item = document.createElement("div");
      item.className = "layerItem" + (isActive ? " active" : "");
      item.onclick = () => setActiveLayer(l.id);

      const top = document.createElement("div");
      top.className = "layerTop";

      const name = document.createElement("div");
      name.className = "layerName";
      name.textContent = "–°–ª–æ–π";

      const pill = document.createElement("div");
      pill.className = "pill";
      pill.textContent = l.locked ? "–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω" : "–†–∞–∑—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω";

      top.appendChild(name);
      top.appendChild(pill);

      const btnRow = document.createElement("div");
      btnRow.className = "row";

      const bLock = document.createElement("button");
      bLock.className = "mini ok";
      bLock.textContent = l.locked ? "–†–∞–∑—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å" : "–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å";
      bLock.onclick = (e) => { e.stopPropagation(); if (!isActive) setActiveLayer(l.id); toggleLock(l.id); };

      const bFit = document.createElement("button");
      bFit.className = "mini";
      bFit.textContent = "–ü–æ–¥ —ç–∫—Ä–∞–Ω";
      bFit.onclick = (e) => { e.stopPropagation(); if (!isActive) setActiveLayer(l.id); fitToScreen(l.id); };

      const bDel = document.createElement("button");
      bDel.className = "mini danger";
      bDel.textContent = "–£–¥–∞–ª–∏—Ç—å";
      bDel.onclick = (e) => { e.stopPropagation(); deleteLayer(l.id); };

      btnRow.appendChild(bLock);
      btnRow.appendChild(bFit);
      btnRow.appendChild(bDel);

      const opacityWrap = document.createElement("div");
      opacityWrap.innerHTML = `<div class="small">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å</div>`;
      const range = document.createElement("input");
      range.type = "range";
      range.min = "0";
      range.max = "100";
      range.value = String(Math.round((l.opacity ?? 0.6) * 100));
      range.oninput = (e) => { e.stopPropagation(); updateOpacity(l.id, Number(e.target.value)/100); };
      opacityWrap.appendChild(range);

      item.appendChild(top);
      item.appendChild(btnRow);
      item.appendChild(opacityWrap);

      layersList.appendChild(item);
    });
  }

  async function addLayerFromDataUrl(dataUrl) {
    const id = genId();
    const bounds = map.getBounds();

    await idbPutLayer(id, dataUrl);

    const overlay = L.imageOverlay(dataUrl, bounds, {
      opacity: 0.6,
      interactive: true
    }).addTo(map);

    overlay.on("click", () => setActiveLayer(id));

    const outline = L.rectangle(bounds, {
      color: "#ff7a00", weight: 2, fill: false, interactive: false
    });

    const layerObj = {
      id,
      opacity: 0.6,
      locked: false, // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–∑—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω
      boundsObj: serializeBounds(bounds),
      overlay,
      outline
    };

    layers.unshift(layerObj);
    activeLayerId = id;
    saveMeta();
    renderLayersList();
    syncActiveOutline();
    showToast("–°–ª–æ–π –¥–æ–±–∞–≤–ª–µ–Ω (—Ä–∞–∑—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω). –î–≤–∏–≥–∞–π —Å—Ç—Ä–µ–ª–∫–∞–º–∏.");
  }

  async function loadLayers() {
    const rawMeta = localStorage.getItem(META_KEY);
    let meta = [];
    try { meta = rawMeta ? (JSON.parse(rawMeta) || []) : []; } catch(e) { meta = []; }

    layers = [];

    for (const m of meta) {
      const dataUrl = await idbGetLayer(m.id);
      if (!dataUrl) continue;

      const bounds = deserializeBounds(m.bounds);
      const overlay = L.imageOverlay(dataUrl, bounds, {
        opacity: typeof m.opacity === "number" ? m.opacity : 0.6,
        interactive: true
      }).addTo(map);

      overlay.on("click", () => setActiveLayer(m.id));

      const outline = L.rectangle(bounds, { color:"#ff7a00", weight: 2, fill:false, interactive:false });

      layers.push({
        id: m.id,
        opacity: typeof m.opacity === "number" ? m.opacity : 0.6,
        locked: (typeof m.locked === "boolean") ? m.locked : false,
        boundsObj: m.bounds,
        overlay,
        outline
      });
    }

    const savedActive = localStorage.getItem(ACTIVE_KEY) || "";
    activeLayerId = (savedActive && getLayer(savedActive)) ? savedActive : (layers[0]?.id || null);
    renderLayersList();
    syncActiveOutline();
  }

  btnAddLayers.onclick = () => { imgFiles.value = ""; imgFiles.click(); };
  imgFiles.onchange = async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    for (const f of files) {
      const dataUrl = await fileToDataURL(f);
      await addLayerFromDataUrl(dataUrl);
    }
  };

  // =====================
  // Move/scale active layer
  // =====================
  function metersToLat(m) { return m / 111320; }
  function metersToLng(m, atLat) { return m / (111320 * Math.cos(atLat * Math.PI/180)); }

  function stepFromEvent(ev) {
    let step = 5;
    if (ev.altKey) step = 1;
    if (ev.shiftKey) step = 20;
    if (ev.ctrlKey || ev.metaKey) step = 50;
    return step;
  }

  function nudgeActive(dxMeters, dyMeters) {
    const l = getActiveLayer();
    if (!l) return;
    if (l.locked) { showToast("–°–ª–æ–π –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Ä–∞–∑—Ñ–∏–∫—Å–∏—Ä—É–π"); return; }

    const b = l.overlay.getBounds();
    const c = b.getCenter();
    const dLat = metersToLat(dyMeters);
    const dLng = metersToLng(dxMeters, c.lat);

    const sw = b.getSouthWest();
    const ne = b.getNorthEast();

    const newBounds = L.latLngBounds(
      [sw.lat + dLat, sw.lng + dLng],
      [ne.lat + dLat, ne.lng + dLng]
    );

    l.overlay.setBounds(newBounds);
    l.outline.setBounds(newBounds);
    l.boundsObj = serializeBounds(newBounds);
    saveMeta();
  }

  function scaleActive(factor) {
    const l = getActiveLayer();
    if (!l) return;
    if (l.locked) { showToast("–°–ª–æ–π –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Ä–∞–∑—Ñ–∏–∫—Å–∏—Ä—É–π"); return; }

    const b = l.overlay.getBounds();
    const c = b.getCenter();
    const sw = b.getSouthWest();
    const ne = b.getNorthEast();

    const halfLat = (ne.lat - sw.lat) / 2;
    const halfLng = (ne.lng - sw.lng) / 2;

    const newBounds = L.latLngBounds(
      [c.lat - halfLat * factor, c.lng - halfLng * factor],
      [c.lat + halfLat * factor, c.lng + halfLng * factor]
    );

    l.overlay.setBounds(newBounds);
    l.outline.setBounds(newBounds);
    l.boundsObj = serializeBounds(newBounds);
    saveMeta();
  }

  document.getElementById("btnLeft").onclick  = () => nudgeActive(-5, 0);
  document.getElementById("btnRight").onclick = () => nudgeActive(+5, 0);
  document.getElementById("btnUp").onclick    = () => nudgeActive(0, +5);
  document.getElementById("btnDown").onclick  = () => nudgeActive(0, -5);

  document.getElementById("btnScaleUp").onclick   = () => scaleActive(1.05);
  document.getElementById("btnScaleDown").onclick = () => scaleActive(0.95);

  document.getElementById("btnFit").onclick = () => {
    const l = getActiveLayer();
    if (!l) return;
    fitToScreen(l.id);
  };

  window.addEventListener("keydown", (ev) => {
    const keys = ["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","+","=","-","_"];
    if (!keys.includes(ev.key)) return;
    ev.preventDefault();

    const step = stepFromEvent(ev);
    if (ev.key === "ArrowLeft")  nudgeActive(-step, 0);
    if (ev.key === "ArrowRight") nudgeActive(+step, 0);
    if (ev.key === "ArrowUp")    nudgeActive(0, +step);
    if (ev.key === "ArrowDown")  nudgeActive(0, -step);

    if (ev.key === "+" || ev.key === "=") scaleActive(1.05);
    if (ev.key === "-" || ev.key === "_") scaleActive(0.95);
  }, { passive:false });

  // =====================
  // Coords check
  // =====================
  const coordsInput = document.getElementById("coordsInput");
  const btnCheckCoords = document.getElementById("btnCheckCoords");
  const coordsResult = document.getElementById("coordsResult");

  function parseCoordsAnyOrder(raw) {
    if (!raw) return null;
    let s = raw.trim();
    const m = s.match(/<coords>(.*?)<\/coords>/i);
    if (m && m[1]) s = m[1].trim();
    s = s.replace(/;/g, ",");
    const parts = s.split(",").map(x => x.trim()).filter(Boolean);
    if (parts.length < 2) return null;

    const a = Number(parts[0]), b = Number(parts[1]);
    if (!Number.isFinite(a) || !Number.isFinite(b)) return null;

    const asLatLng = { lat: a, lng: b };
    const asLngLat = { lat: b, lng: a };
    const ok = (p) => p.lat >= -90 && p.lat <= 90 && p.lng >= -180 && p.lng <= 180;

    if (ok(asLatLng) && ok(asLngLat)) {
      const d1 = Math.abs(asLatLng.lat - 59.93) + Math.abs(asLatLng.lng - 30.33);
      const d2 = Math.abs(asLngLat.lat - 59.93) + Math.abs(asLngLat.lng - 30.33);
      return d1 <= d2 ? asLatLng : asLngLat;
    }
    if (ok(asLatLng)) return asLatLng;
    if (ok(asLngLat)) return asLngLat;
    return null;
  }

  function checkPointInZones(lat, lng) {
    const geo = zonesGroup.toGeoJSON();
    if (!geo?.features?.length) return { ok:false, msg:"–ó–æ–Ω –µ—â—ë –Ω–µ—Ç ‚Äî –Ω–∞—Ä–∏—Å—É–π." };

    const pt = turf.point([lng, lat]);
    let best = null;

    for (const f of geo.features) {
      if (!f?.geometry) continue;
      if (f.geometry.type !== "Polygon" && f.geometry.type !== "MultiPolygon") continue;

      let inside = false;
      try { inside = turf.booleanPointInPolygon(pt, f); } catch(e) {}
      if (!inside) continue;

      const score = Number(f.properties?.zone_score ?? 0);
      if (!best || score > best.score) {
        best = { zone: f.properties?.zone_label || f.properties?.zone_type || "unknown", score };
      }
    }

    if (!best) return { ok:false, msg:"–¢–æ—á–∫–∞ –Ω–µ –ø–æ–ø–∞–ª–∞ –Ω–∏ –≤ –æ–¥–Ω—É –∑–æ–Ω—É." };
    return { ok:true, ...best };
  }

  btnCheckCoords.onclick = () => {
    const p = parseCoordsAnyOrder(coordsInput.value);
    if (!p) { coordsResult.textContent = "–ù–µ —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã."; return; }

    map.setView([p.lat, p.lng], Math.max(map.getZoom(), 16));
    const res = checkPointInZones(p.lat, p.lng);

    coordsResult.innerHTML = res.ok
      ? `<b>–¢–æ—á–∫–∞:</b> ${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}<br><b>–ó–æ–Ω–∞:</b> ${res.zone}<br><b>Score:</b> ${res.score}`
      : `<b>–¢–æ—á–∫–∞:</b> ${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}<br><b>–†–µ–∑—É–ª—å—Ç–∞—Ç:</b> ${res.msg}`;
  };

  // =====================
  // Init
  // =====================
  loadZonesFromStorage();
  updateGeo();
  setDrawStateText();

  loadLayers().then(() => {
    showToast("–ì–æ—Ç–æ–≤–æ. –î–æ–±–∞–≤—å —Å–∫—Ä–∏–Ω(—ã). –î–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –Ω–∞–∂–º–∏ —É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç–∏.");
  });
</script>

</body>
</html>
